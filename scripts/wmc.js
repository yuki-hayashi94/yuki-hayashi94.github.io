function boltemcd(){for(i=0;i<=nx1;i++)dpsi[i]=psi[i]-ec0[i]/q,jt>=jtrans&&(adpsi[i]=adpsi[i]+dpsi[i],odpsi[i]=adpsi[i]/(jt-(jtrans-1)));for(i=1;i<=nx1-1;i++)qhf[i]=qh*(dpsi[i+1]-dpsi[i-1])/dx/2;for(qhf[0]=qhf[1],qhf[nx1]=qhf[nx1-1],tdt=t+dt,n=1;n<=inum;n++){for(kx=p[n][1],ky=p[n][2],kz=p[n][3],ts=p[n][4],x=p[n][5],affi=p[n][6],iv=ip[n],t1=t;ts<tdt;)tau=ts-t1,drift(tau),"scatall"===iscatt?scat():"scatelect"===iscatt&&(x<=ivleft*dx||x>=ivright*dx)&&scat(),t1=ts,x<=ivleft*dx||x>=ivright*dx?ts=t1-Math.log(rnd())/gm1:ts=t1-Math.log(rnd())/gm2;tau=tdt-t1,drift(tau),p[n][1]=kx,p[n][2]=ky,p[n][3]=kz,p[n][4]=ts,p[n][5]=x,p[n][6]=affi,ip[n]=iv}}function renew(){var t=[];for(dop1>0?t[1]=np1/2+1:t[1]=1,dop5>0?t[2]=np1/2+1:t[2]=1,znpt[1]=0,znpt[2]=0,nn=inum,n=1;n<=nn;n++){for(;9==ip[inum];)inum-=1;if(n>=inum){for(;9==ip[inum];)inum-=1;if(n>=inum)break;if(i=Math.max(0,Math.min(Math.floor(p[n][5]/dx+.5),nx1)),posleft=dx/2,posright=xmax-dx/2,p[n][5]<posleft)ic=1;else{if(!(p[n][5]>posright))continue;ic=2}if(Math.floor(znpt[ic]+.5)>=t[ic]){for(j=1;j<=6;j++)p[n][j]=p[inum][j];ip[n]=ip[inum],ip[inum]=9,inum-=1}else znpt[ic]=znpt[ic]+1*p[n][6]}else{if(9==ip[n]){for(j=1;j<=6;j++)p[n][j]=p[inum][j];ip[n]=ip[inum],ip[inum]=9,inum-=1}for(;9==ip[inum];)inum-=1;if(n>=inum)break;if(i=Math.max(0,Math.min(Math.floor(p[n][5]/dx+.5),nx1)),posleft=dx/2,posright=xmax-dx/2,p[n][5]<posleft)ic=1;else{if(!(p[n][5]>posright))continue;ic=2}if(Math.floor(znpt[ic]+.5)>=t[ic]){for(j=1;j<=6;j++)p[n][j]=p[inum][j];ip[n]=ip[inum],ip[inum]=9,inum-=1}else znpt[ic]=znpt[ic]+1*p[n][6]}}for(mi=0,ic=1;ic<=2;ic++)if(nicrea=t[ic]-Math.floor(znpt[ic]+.5),!(nicrea<0)){for(ic,nin1+=nicrea,ic,nin2+=nicrea,j=1;j<=nicrea;j++)n=inum+j,crea(ic),p[n][1]=kx,p[n][2]=ky,p[n][3]=kz,p[n][4]=ts,p[n][5]=x,p[n][6]=affi,ip[n]=iv;inum+=nicrea}}function charge(){for(i=0;i<=nx1;i++)cn0[i]=0,vx0[i]=0,eng0[i]=0;for(n=1;n<=inum;n++){if(p[n][5]<0){const i=!0;try{if(console.log("carrier miss"),i)throw new Error("error")}catch(i){console.log(i.message)}}iv=ip[n],9!=iv&&(xpos1=p[n][5]/dx,i=Math.max(0,Math.min(Math.floor(xpos1+.5),nx1)),cn0[i]=cn0[i]+1*p[n][6],vx0[i]=vx0[i]+1*hm*p[n][1]*p[n][6],sk=p[n][1]*p[n][1]+p[n][2]*p[n][2]+p[n][3]*p[n][3],en[n]=hhm*sk)}if(jt<jtrans)for(i=0;i<=nx1;i++)cn0[i]<=0?(vx[i]=0,eng0[i]=0):(vx[i]=vx0[i]/cn0[i],eng[i]=eng0[i]/cn0[i]),cn[i]=cn0[i]*epp/dx,0!=i&&i!=nx1||(cn[i]=2*cn[i]);else for(jt==jtrans&&(console.log("========================================="),console.log("---- Steady-State Estimators Started ----"),console.log("========================================="),console.log()),i=0;i<=nx1;i++)acn[i]=acn[i]+cn0[i],avx[i]=avx[i]+vx0[i],aeng[i]=aeng[i]+eng0[i],acn[i]<=0?(vx[i]=0,eng[i]=0):(vx[i]=avx[i]/acn[i],eng[i]=aeng[i]/acn[i]),ocn[i]=acn[i]/(jt-(jtrans-1)),ocn[i]=ocn[i]*epp/dx,0!=i&&i!=nx1||(cn0[i]=2*cn0[i]),cn[i]=cn0[i]*epp/dx,0!=i&&i!=nx1||(ocn[i]=2*ocn[i])}function poisso(){var n=new Array(nx1+1),p=new Array(nx1+1);for(psi[0]=0,psi[nx1]=vd,i=1;i<=nx-1;i++)p[i]=(cn[i]-cp[i]-cnd[i])*qeps[i];for(p[1]=p[1]-a1[1]*psi[0],p[nx-1]=p[nx-1]-c1[nx-1]*psi[nx1],n[1]=p[1]/b1[1],i=2;i<=nx-1;i++)n[i]=(p[i]-a1[i]*n[i-1])/bt[i];for(psi[nx-1]=n[nx-1],i=nx-2;i>=1;i--)psi[i]=n[i]-gmm[i]*psi[i+1]}function current(){for(i=1;i<=nx;i++)CurrQNV[i]=q*cn[i]*vx[i]-q*cp[i]*vxp[i];for(AVCurrQNV=0,i=1;i<=nx;i++)AVCurrQNV+=CurrQNV[i];AVCurrQNV/=nx,jt>=jtrans&&(jcurrRS+=1,SumCurr1+=CurrRSc,SumCurr2+=CurrRSt,SumCurr3+=AVCurrQNV,CurRSavc=SumCurr1/jcurrRS,CurRSavt=SumCurr2/jcurrRS,CurQNVav=SumCurr3/jcurrRS)}function boltemcdp(){for(tdt=t+dt,n=1;n<=inum2;n++){for(kx2=p2[n][1],ky2=p2[n][2],kz2=p2[n][3],ts2=p2[n][4],xp=p2[n][5],affi2=p2[n][6],iv2=ip2[n],t1=t;ts2<tdt;)tau2=ts2-t1,driftp(tau2),"scatall"===iscatt?scatp():"scatelect"===iscatt&&(xp<=ivleft*dx||xp>=ivright*dx)&&scatp(),t1=ts2,xp<=ivleft*dx||xp>=ivright*dx?ts2=t1-Math.log(rnd())/gm1p:ts2=t1-Math.log(rnd())/gm2p;tau2=tdt-t1,driftp(tau2),p2[n][1]=kx2,p2[n][2]=ky2,p2[n][3]=kz2,p2[n][4]=ts2,p2[n][5]=xp,p2[n][6]=affi2,ip2[n]=iv2}}function renewp(){var p=[];for(dop1<0?p[1]=np1/2+1:p[1]=1,dop5<0?p[2]=np1/2+1:p[2]=1,znpt[1]=0,znpt[2]=0,nn2=inum2,n=1;n<=nn2;n++){for(;9==ip2[inum2];)inum2-=1;if(n>=inum2){for(;9==ip2[inum2];)inum2-=1;if(n>=inum2)break;if(i=Math.max(0,Math.min(Math.floor(p2[n][5]/dx+.5),nx1)),posleft=dx/2,posright=xmax-dx/2,p2[n][5]<posleft)ic=1;else{if(!(p2[n][5]>posright))continue;ic=2}if(Math.floor(znpt[ic]+.5)>=p[ic]){for(j=1;j<=6;j++)p2[n][j]=p2[inum2][j];ip2[n]=ip2[inum2],ip2[inum2]=9,inum2-=1}else znpt[ic]=znpt[ic]+1*p2[n][6]}else{if(9==ip2[n]){for(j=1;j<=6;j++)p2[n][j]=p2[inum2][j];ip2[n]=ip2[inum2],ip2[inum2]=9,inum2-=1}for(;9==ip2[inum2];)inum2-=1;if(n>=inum2)break;if(i=Math.max(0,Math.min(Math.floor(p2[n][5]/dx+.5),nx1)),posleft=dx/2,posright=xmax-dx/2,p2[n][5]<posleft)ic=1;else{if(!(p2[n][5]>posright))continue;ic=2}if(Math.floor(znpt[ic]+.5)>=p[ic]){for(j=1;j<=6;j++)p2[n][j]=p2[inum2][j];ip2[n]=ip2[inum2],ip2[inum2]=9,inum2-=1}else znpt[ic]=znpt[ic]+1*p2[n][6]}}for(mi=0,ic=1;ic<=2;ic++)if(nicrea=p[ic]-Math.floor(znpt[ic]+.5),!(nicrea<0)){for(ic,nin1+=nicrea,ic,nin2+=nicrea,j=1;j<=nicrea;j++)n=inum2+j,creap(ic),p2[n][1]=kx2,p2[n][2]=ky2,p2[n][3]=kz2,p2[n][4]=ts2,p2[n][5]=xp,p2[n][6]=affi2,ip2[n]=iv2;inum2+=nicrea}}function chargep(){for(i=0;i<=nx1;i++)cp0[i]=0,vxp0[i]=0;for(n=1;n<=inum2;n++){if(p2[n][5]<0){const i=!0;try{if(console.log("carrier miss"),i)throw new Error("error")}catch(i){console.log(i.message)}}iv2=ip2[n],9!=iv2&&(xpos1=p2[n][5]/dx,i=Math.max(0,Math.min(Math.floor(xpos1+.5),nx1)),cp0[i]=cp0[i]+1*p2[n][6],vxp0[i]=vxp0[i]+1*hmp*p2[n][1]*p2[n][6],sk=p[n][1]*p[n][1]+p[n][2]*p[n][2]+p[n][3]*p[n][3])}if(jt<jtrans)for(i=0;i<=nx1;i++)cp0[i]<=0?vxp[i]=0:vxp[i]=vxp0[i]/cp0[i],cp[i]=cp0[i]*epp/dx,0!=i&&i!=nx1||(cp[i]=2*cp[i]);else for(i=0;i<=nx1;i++)acp[i]=acp[i]+cp0[i],avxp[i]=avxp[i]+vxp0[i],acp[i]<=0?vxp[i]=0:vxp[i]=avxp[i]/acp[i],ocp[i]=acp[i]/(jt-(jtrans-1)),ocp[i]=ocp[i]*epp/dx,0!=i&&i!=nx1||(cp0[i]=2*cp0[i]),cp[i]=cp0[i]*epp/dx,0!=i&&i!=nx1||(ocp[i]=2*ocp[i])}function poissop(){var n=new Array(nx1+1),p=new Array(nx1+1);for(psi[0]=0,psi[nx1]=-vd,i=1;i<=nx-1;i++)p[i]=(cn[i]-cp[i]-cnd[i])*qeps[i];for(p[1]=p[1]-a1[1]*psi[0],p[nx-1]=p[nx-1]-c1[nx-1]*psi[nx1],n[1]=p[1]/b1[1],i=2;i<=nx-1;i++)n[i]=(p[i]-a1[i]*n[i-1])/bt[i];for(psi[nx-1]=n[nx-1],i=nx-2;i>=1;i--)psi[i]=n[i]-gmm[i]*psi[i+1]}function wmc(){boltemcd(),renew(),charge(),poisso(),current()}function wmcp(){boltemcd(),boltemcdp(),renew(),renewp(),charge(),chargep(),poissop(),current()}
